{% extends "base.html" %}

{% block content %}
<h1>Configuración</h1>

<p>En esta sección se pueden dar de alta las ofertas recibidas por distintas compañias que se utilizarán en el apartado de costes</p>

<div class="ui main text container">
    <div class="ui icon floating yellow centered message">
        <div class="header">
            ¡Atención!
        </div>
        <div class="content">
            <p>Ningún dato introducido será enviado a ningún servidor, ni compartido con ninguna empresa. Los datos introducidos únicamente serán guardados en el navegador. Si se accede a la web desde otro navedador, los datos no estarán disponibles.</p>
        </div>
    </div>
</div>

{% include "parts/rate_20td_header.html" %}

<div id="offers_rate_20td" class="ui form">
    <p class="nocontent">Sin ofertas</p>
</div>
<div class="ui blue button offer-add" data-rate-type="20td">
    <i class="plus icon"></i>Añadir
</div>

{% include "parts/rate_wk_header.html" %}

<div id="offers_rate_wk" class="ui form">
    <p class="nocontent">Sin ofertas</p>
</div>
<div class="ui blue button offer-add" data-rate-type="wk">
    <i class="plus icon"></i>Añadir
</div>

{% include "parts/rate_fix_header.html" %}

<div id="offers_rate_fix" class="ui form">
    <p class="nocontent">Sin ofertas</p>
</div>
<div class="ui blue button offer-add" data-rate-type="fix">
    <i class="plus icon"></i>Añadir
</div>

<div class="ui divider"></div>

<form id="configuration-form" class="ui form">
    <input type="file" id="import-file" accept="*.json" style="display:none">

    <div class="ui right floated floating labeled icon dropdown yellow button">
        <i class="upload icon"></i>
        <span class="text">Importar</span>
        <div class="menu">
            <div id="import_url_modal_button" class="item" data-modal-id="import_url_modal"><i class="linkify icon"></i> URL</div>
            <div id="import_file_button" class="item"><i class="file icon"></i> Fichero</div>
        </div>
    </div>
    <button id="export-button" class="ui right floated labeled icon green button"  type="button" data-filename="configuration.json">
        <i class="download icon"></i>
        Exportar
    </button>
</form>

<div id="import_url_modal" class="ui modal" data-trigger-button="import_url_modal_button">
    <h2 class="ui header">Importar configuración remota</h2>
    <div class="content">
        <form class="ui form">
            <div class="field">
                <label>URL</label>
                <input type="text" name="import_url" value="https://raw.githubusercontent.com/{{github_username}}/energydatum/main/{{configuration_backup_filename}}">
            </div>
        </form>
    </div>
    <div class="actions">
        <div id="import_url_button" class="ui yellow ok button">
            <i class="check icon"></i>
            Importar
        </div>
    </div>
</div>
{% endblock %}

{% block custom_javascript %}
<script type="text/javascript" charset="utf8">
    function getTimestamp() {
        let date = new Date();

        ye = date.getYear();
        mo = date.getMonth() + 1;
        da = date.getDate();
        ho = date.getHours();
        mi = date.getMinutes();
        se = date.getSeconds();

        return `${ye}${mo.toString().padStart(2, '0')}${da.toString().padStart(2, '0')}${ho.toString().padStart(2, '0')}${mi.toString().padStart(2, '0')}${se.toString().padStart(2, '0')}`
    }

    function insertNewRow(rateType) {
        $.get(`{{contextpath}}/assets/html/rate_${rateType}_add_row_template.html?ts=${getTimestamp()}`).done(data => {
            $data = $(data)

            $data.find('.calendar-comp').calendar({
                type: 'date',
                firstDayOfWeek: 1,
                maxDate: new Date(),
                text: {
                    days: ['D', 'L', 'M', 'X', 'J', 'V', 'S'],
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                    monthsShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                    today: 'Hoy',
                    now: 'Ahora',
                    am: 'AM',
                    pm: 'PM'
                },
                formatter: {
                    date: function (date, settings) {
                        if (!date) return '';
                        var day = date.getDate();
                        var month = date.getMonth() + 1;
                        var year = date.getFullYear();

                        return day.toString().padStart(2, '0') + '/' + month.toString().padStart(2, '0') + '/' + year;
                    }
                }
            });

            $data.find('.popup-comp').popup();

            $(`#offers_rate_${rateType} .nocontent`).remove();
            $(`#offers_rate_${rateType}`).append($data);
        });
    }

    function addRow(offer) {
        $.get(`{{contextpath}}/assets/html/rate_${offer.rateType}_view_row_template.html?ts=${getTimestamp()}`).done(data => {
            $data = $(data)
            $data.attr('id', offer.id);
            $data.find('input[name="company"]').val(offer.company);
            $data.find('input[name="date"]').val(offer.date);

            if (offerdb.consumptionOfferIsCurrent(offer.id)) {
                $data.find('input[name="current"]').attr('checked', 'checked');
            }

            offer.periods.forEach((period, i) => {
                $periodInput = $data.find(`input[name=${period[0]}]`);
                $periodInput.val(period[1]);

                if (offer.dto) {
                    $periodLabel = $periodInput.siblings('label');

                    $periodLabel.append($('<i>', { 'class': 'info circle icon popup-comp', 'data-title': 'Precio original', 'data-content': `${offer.rawPeriods[i][1]} € (Sin dto del ${offer.dto} %)` }));
                }
            });

            $data.find('.popup-comp').popup();

            $data.find('.checkbox-comp').checkbox({
                uncheckable: true,
                onChecked: function(handler) {
                    offerdb.setConsumptionOfferAsCurrent($(this).parents('.fields').attr('id'));
                },
                onUnchecked: function(handler) {
                    offerdb.unsetConsumptionOfferAsCurrent();
                }
            });

            $(`#offers_rate_${offer.rateType} .nocontent`).remove();
            $(`#offers_rate_${offer.rateType}`).append($data);
        });
    }

    function refreshNoContent(rateType) {
        offerCount = $(`#offers_rate_${rateType} .fields`).length;

        if (offerCount === 0) {
            $(`#offers_rate_${rateType}`).append($('<p>', {'class': 'nocontent', 'text': 'Sin ofertas'}));
        }
    }

    function refreshOffers() {
        $('div[id*="offers_rate_"]').empty().append($('<p>', {'class': 'nocontent', 'text': 'Sin ofertas'}));

        offers = offerdb.getAllConsumptionOffers();

        offers.forEach(offer => {
            addRow(offer);
        });
    }

    $(document).ready(function() {
        refreshOffers();

        $('#configuration-form .ui.dropdown').dropdown({
            on: 'hover',
            action: 'hide'
        });

        $('.offer-add').click(handler => {
            rateType = $(handler.currentTarget).data('rate-type');

            insertNewRow(rateType);
        });

        $(document).on('click', '.offer-save', handler => {
            $element = $(handler.currentTarget);
            $fields = $element.closest('.fields');

            company = $fields.find('input[name="company"]').val();
            rateType = $element.data('rate-type');
            date = $fields.find('input[name="date"]').val();
            periods = [];

            $fields.find('input.period').each((i, elem) => {
                $elem = $(elem)
                periods.push([$elem.attr('name'), $elem.val()]);
            });

            dto = $fields.find('input[name="dto"]').val() || 0;

            offer = offerdb.saveConsumptionOffer(company, date, rateType, periods, dto);

            $fields.remove();
            addRow(offer);
        });

        $(document).on('click', '.offer-delete', handler => {
            $element = $(handler.currentTarget);
            rateType = $element.data('rate-type');
            $fields = $element.closest('.fields');

            offerdb.deleteConsumptionOffer($fields.attr('id'));

            $fields.remove();
            refreshNoContent(rateType);
        });

        $(document).on('click', '.offer-cancel', handler => {
            $element = $(handler.currentTarget);
            rateType = $element.data('rate-type');
            $fields = $element.closest('.fields');

            $fields.remove();
            refreshNoContent(rateType);
        });

        $('#import_url_button').click(handler => {
            handler.preventDefault();
            $form = $(handler.currentTarget).parents('.ui.modal').find('.ui.form');
            let url = $form.find('input[name="import_url"]').val().trim();

            $.get(url).done(data => {
                offerdb.load(JSON.parse(data));

                refreshOffers();
            });
        });

        $('#import_file_button').click(handler => {
            handler.preventDefault();

            if ('FileReader' in window) {
                $('input#import-file').click();
            } else {
                alert('Your browser does not support the HTML5 FileReader.');
            }
        });

        $('input#import-file').change(event => {
            var fileToLoad = event.target.files[0];

            if (fileToLoad) {
                var fileReader = new FileReader();

                fileReader.onload = function(fileLoadedEvent) {
                    var textFromFileLoaded = fileLoadedEvent.target.result;

                    offerdb.load(JSON.parse(textFromFileLoaded));

                    refreshOffers();
                };

                fileReader.readAsText(fileToLoad, 'UTF-8');
            }
        });

        $('button#export-button').click(handler => {
            handler.preventDefault();
            $element = $(handler.currentTarget);
            let fileName = $element.data('filename');

            if ('Blob' in window) {
                var blob = new Blob([JSON.stringify(offerdb.dump())], {type: 'application/json'});

                if ('msSaveOrOpenBlob' in navigator) {
                    navigator.msSaveOrOpenBlob(blob, fileName);
                } else {
                    var downloadLinkElement = document.createElement('a');
                    downloadLinkElement.download = fileName;
                    downloadLinkElement.innerHTML = 'Download File';

                    if ('webkitURL' in window) {
                        downloadLinkElement.href = window.webkitURL.createObjectURL(blob);
                    } else {
                        downloadLinkElement.href = window.URL.createObjectURL(blob);
                    }

                    downloadLinkElement.onclick = event => {
                        document.body.removeChild(event.target);
                    };

                    downloadLinkElement.style.display = 'none';
                    document.body.appendChild(downloadLinkElement);

                    downloadLinkElement.click();
                }
            } else {
                alert('Your browser does not support the HTML5 Blob.');
            }
        });
    });
</script>
{% endblock %}