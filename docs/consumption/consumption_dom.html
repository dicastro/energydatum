<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="viewport" content="width=1024, maximum-scale=1.0, user-scalable=no">

    <title>Energy Datum</title>

    <link rel="icon" href="/energydatum/assets/img/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/energydatum/assets/jqueryui/1.13.1/css/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/energydatum/assets/fomanticui/2.8.8/css/semantic.min.css">
    <link rel="stylesheet" type="text/css" href="/energydatum/assets/datatables/1.11.5/css/dataTables.semanticui.min.css">
    <link rel="stylesheet" type="text/css" href="/energydatum/assets/css/style.css">
</head>
<body>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/plotly/2.12.1/js/plotly.min.js"></script>
<script type="text/javascript">
    window.PlotlyConfig = {MathJaxConfig: 'local'};
</script>

<div class="ui borderless main menu">
    <div class="ui text container">
        <div class="header item">
            <img class="logo" src="/energydatum/assets/img/logo_40x40.png">
            Energy Datum
        </div>
        <div class="ui floating dropdown button item">
            <div class="text">Consumo</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                <a id="consumption_y_menu_item" class=" item" href="/energydatum/consumption/consumption_y.html">Anual</a>
                <a id="consumption_moy_menu_item" class=" item" href="/energydatum/consumption/consumption_moy.html">Mensual</a>
                <a id="consumption_dow_menu_item" class=" item" href="/energydatum/consumption/consumption_dow.html">Día semana</a>
                <a id="consumption_hod_menu_item" class=" item" href="/energydatum/consumption/consumption_hod.html">Horario</a>
                <a id="period_m_menu_item" class=" item" href="/energydatum/consumption/period_m.html">Periodo</a>
                <a id="consumption_dom_menu_item" class="active item" href="/energydatum/consumption/consumption_dom.html">Diario</a>
            </div>
        </div>
        <a id="cost_menu_item" class=" item" href="/energydatum/cost.html">Coste</a>
        <div class="ui floating dropdown button item">
            <div class="text">Datos</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="item">
                    <i class="dropdown icon"></i>
                    Precios PVPC
                    <div class="right menu">
                        <a id="price_buy_pvpc_menu_item" class=" item" href="/energydatum/esios/esios_price_buy_20td.html">Compra</a>
                        <a id="price_sell_pvpc_menu_item" class=" item" href="/energydatum/esios/esios_price_sell_20td.html">Venta</a>
                    </div>
                </div>
                <div class="divider"></div>
                <a id="bank_days_menu_item" class=" item" href="/energydatum/bank_days.html">Festivos</a>
                <div class="divider"></div>
                <a id="esios_indicators_menu_item" class=" item" href="/energydatum/esios/esios_indicators.html">Indicadores E-SIOS</a>
                <div class="divider"></div>
                <a id="weather_menu_item" class=" item" href="/energydatum/weather.html">Clima</a>
            </div>
        </div>
        <div class="ui floating dropdown button item">
            <div class="text">Autoconsumo</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                
                <a id="calibrations_menu_item" class=" item" href="/energydatum/selfsupply/calibrations.html">Calibrado</a>
                
                <a id="production_estimation_menu_item" class=" item" href="/energydatum/selfsupply/production.html">Producción</a>
            </div>
        </div>
        <a id="configuration_menu_item" class="item right " href="/energydatum/configuration.html">
            <i class="cogs icon"></i>
        </a>
    </div>
</div>

<div class="ui container">
    
<h1 class="ui header">Consumo diario</h1>

<p>Selecciona un día del calendario para ver el detalle de su consumo por horas</p>

<div class="content">
    <div class="ui form">
        <div class="fields">
            <div class="ui calendar three wide field calendar-comp">
                <label>Fecha</label>
                <div class="ui input left icon">
                    <i class="calendar icon"></i>
                    <input name="date" type="text" placeholder="Fecha" maxlength="10">
                </div>
            </div>
            <div class="two wide field">
                <label>&nbsp;</label>
                <div class="ui icon green button day-add" data-rate-type="20td">
                    <i class="plus icon"></i>
                </div>
            </div>
        </div>
        <div id="selected-days" class="ui segment">
            <p class="nocontent">No se ha seleccionado ningún día</p>
        </div>
    </div>

    <div id="consumption-figure" class="plotly-graph-div" style="height:100%; width:100%;"></div>
</div>

</div>

<div class="ui inverted vertical footer segment">
    <div class="ui center aligned container">
        <div class="ui stackable inverted divided grid">
            <div class="three wide column">
                <h4 class="ui inverted header">Consumo</h4>
                <div class="ui inverted link list">
                    <a class="item" href="/energydatum/consumption/consumption_y.html">Anual</a>
                    <a class="item" href="/energydatum/consumption/consumption_moy.html">Mensual</a>
                    <a class="item" href="/energydatum/consumption/consumption_dow.html">Día semana</a>
                    <a class="item" href="/energydatum/consumption/consumption_hod.html">Horario</a>
                    <a class="item" href="/energydatum/consumption/period_m.html">Periodo</a>
                    <a class="item" href="/energydatum/consumption/consumption_dom.html">Diario</a>
                </div>
            </div>
            <div class="three wide column">
                <h4 class="ui inverted header">Datos</h4>
                <div class="ui inverted link list">
                    <a class="item" href="/energydatum/esios/esios_price_buy_20td.html">Precios PVPC - Compra</a>
                    <a class="item" href="/energydatum/esios/esios_price_sell_20td.html">Precios PVPC - Venta</a>
                    <a class="item" href="/energydatum/bank_days.html">Festivos</a>
                    <a class="item" href="/energydatum/esios/esios_indicators.html">Indicadores E-SIOS</a>
                    <a class="item" href="/energydatum/weather.html">Clima</a>
                </div>
            </div>
            <div class="three wide column">
                <h4 class="ui inverted header">Autoconsumo</h4>
                <div class="ui inverted link list">
                    
                    <a class="item" href="/energydatum/selfsupply/calibrations.html">Calibrado</a>
                    
                    <a class="item" href="/energydatum/selfsupply/production.html">Producción</a>
                </div>
            </div>
            <div class="seven wide column">
                <h4 class="ui inverted header">¿Quieres un sitio como este?</h4>
                <div class="ui left aligned container">
                    <p>Es muy fácil, únicamente tienes que seguir estos sencillos pasos:</p>
                    <ol>
                        <li>Haz un fork de <a href="https://github.com/dicastro/energydatum" target="_blank">Energy Datum</a></li>
                        <li>Clona tu repo</li>
                        <li>Añade las lecturas de tu contador en formato <i>csv</i></li>
                        <li>Ejecuta el script <code>run.cmd</code></li>
                        <li>Haz push de los cambios</li>
                    </ol>
                </div>
            </div>
        </div>
        <div class="ui inverted section divider"></div>
        <img src="/energydatum/assets/img/logo_40x40.png" class="ui centered mini image">
        <div class="ui horizontal inverted small divided link list">
            <a class="item" href="https://diegocastroviadero.com/#contact" target="_blank">Contáctame</a>
            <p class="item">1.0.0-alpha5</p>
            <p class="item">Generado el 16/06/2022 con datos entre 01/06/2020 y 31/05/2022</p>
        </div>
    </div>
</div>

<script type="text/javascript" charset="utf8" src="/energydatum/assets/jquery/3.6.0/js/jquery.min.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/jqueryui/1.13.1/js/jquery-ui.min.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/datatables/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/datatables/1.11.5/js/dataTables.semanticui.min.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/fomanticui/2.8.8/js/semantic.min.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/dataframejs/1.4.3/js/dataframe.min.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/js/menu.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/js/main.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/js/table.js"></script>
<script type="text/javascript" charset="utf8" src="/energydatum/assets/js/offer-db.js"></script>

<script type="text/javascript" charset="utf-8">
    window.PLOTLYENV=window.PLOTLYENV || {};

    const COLOR_SEQ = ['#636efa', '#EF553B', '#00cc96', '#ab63fa', '#FFA15A', '#19d3f3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'];

    const plotlyFigureConfig = {"responsive": true};

    const plotlyFigureLayout = {
        "template": {
            "data": {
                "histogram2dcontour": [{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],
                "choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],
                "histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],
                "heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],
                "heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],
                "contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],
                "contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],
                "surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],
                "mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],
                "scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],
                "parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],
                "scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],
                "scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],
                "carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],
                "table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],
                "barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],
                "pie":[{"automargin":true,"type":"pie"}]
            },
            "layout": {
                "autotypenumbers":"strict",
                "colorway": COLOR_SEQ,
                "font":{"color":"#2a3f5f"},
                "hovermode":"closest",
                "hoverlabel":{"align":"left"},
                "paper_bgcolor":"white",
                "plot_bgcolor":"#E5ECF6",
                "polar": {
                    "bgcolor":"#E5ECF6",
                    "angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},
                    "radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}
                },
                "ternary": {
                    "bgcolor":"#E5ECF6",
                    "aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},
                    "baxis":{"gridcolor":"white","linecolor":"white","ticks":""},
                    "caxis":{"gridcolor":"white","linecolor":"white","ticks":""}
                },
                "coloraxis": {
                    "colorbar":{"outlinewidth":0,"ticks":""}
                },
                "colorscale": {
                    "sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],
                    "sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],
                    "diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]
                },
                "xaxis": {
                    "gridcolor":"white",
                    "linecolor":"white",
                    "ticks":"",
                    "title":{"standoff":15},
                    "zerolinecolor":"white",
                    "automargin":true,
                    "zerolinewidth":2
                },
                "yaxis": {
                    "gridcolor":"white",
                    "linecolor":"white",
                    "ticks":"",
                    "title":{"standoff":15},
                    "zerolinecolor":"white",
                    "automargin":true,
                    "zerolinewidth":2
                },
                "scene": {
                    "xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},
                    "yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},
                    "zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}
                },
                "shapedefaults": {
                    "line":{"color":"#2a3f5f"}
                },
                "annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},
                "geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},
                "title":{"x":0.05},
                "mapbox":{"style":"light"}
            }
        },
        "xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"Hora"}},
        "yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"Consumo (kWh)"}},
        "legend":{
            "title": {
                "text": "Día"
            },
            "tracegroupgap":0
        },
        "margin":{"t":60}
    };

    function getValuesFromMonthConsumptionDf(df, day) {
        return df.filter(row => row.get('dom') === day).select('hour_consumption_kwh').toDict()['hour_consumption_kwh']
    }

    function addSelectedDay(dayData) {
        $('#selected-days .nocontent').remove();
        $('<div>', {
            class: 'ui left icon label selected-day',
            style: `color: #ffffff; background-color: ${dayData.line.color};`,
            'data-date': `${dayData.name}`,
            html: `<i class="close icon day-remove"></i>${dayData.name}`
        }).appendTo('#selected-days');
    }

    db = {
        COLOR_SEQ: ['#636efa', '#EF553B', '#00cc96', '#ab63fa', '#FFA15A', '#19d3f3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52'],
        _getColor(title) {
            if (!('daily_consumption_color_seq' in sessionStorage)) {
                sessionStorage.setItem('daily_consumption_color_seq', JSON.stringify(COLOR_SEQ));
            }

            let colorSeq = JSON.parse(sessionStorage.getItem('daily_consumption_color_seq'));

            let colors = JSON.parse(sessionStorage.getItem('daily_consumption_colors')) || {};

            if (!(title in colors)) {
                selectedColor = colorSeq.shift();
                colors[title] = selectedColor;

                sessionStorage.setItem('daily_consumption_color_seq', JSON.stringify(colorSeq));
                sessionStorage.setItem('daily_consumption_colors', JSON.stringify(colors));
            } else {
                selectedColor = colors[title];
            }

            return selectedColor;
        },
        _getConsumptionFigureData(title, values) {
            return {
                'hovertemplate': `Fecha=${title}<br>Hora=%{x}<br>Consumo (kWh)=%{y}<extra></extra>`,
                'legendgroup': title,
                'line': {
                    'color': this._getColor(title),
                    'dash': 'solid'
                },
                'marker': {
                    'symbol': 'circle'
                },
                'mode': 'lines',
                'name': title,
                'orientation': 'v',
                'showlegend': true,
                'x': ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23'],
                'xaxis': 'x',
                'y': values,
                'yaxis': 'y',
                'type': 'scatter'
            }
        },
        _getDailyConsumptionDates: function () {
            return Object.keys(sessionStorage).filter(key => key.match(/daily_consumption_\d{2}\/\d{2}\/\d{4}/));
        },
        containsDate: function(date) {
            dailyConsumptionKey = `daily_consumption_${date}`;

            return date in sessionStorage;
        },
        addDate: function(title, values) {
            data = this._getConsumptionFigureData(title, values);

            sessionStorage.setItem(`daily_consumption_${title}`, JSON.stringify(data));

            return data;
        },
        getData: function() {
            return this._getDailyConsumptionDates().map(key => JSON.parse(sessionStorage.getItem(key)));
        },
        hasData: function() {
            return this._getDailyConsumptionDates().length > 0;
        },
        removeDate: function(date) {
            sessionStorage.removeItem(`daily_consumption_${date}`);

            let colorSeq = JSON.parse(sessionStorage.getItem('daily_consumption_color_seq'));

            let colors = JSON.parse(sessionStorage.getItem('daily_consumption_colors'));

            color = colors[date];

            delete colors[date];
            colorSeq.unshift(color);

            sessionStorage.setItem('daily_consumption_color_seq', JSON.stringify(colorSeq));
            sessionStorage.setItem('daily_consumption_colors', JSON.stringify(colors));
        }
    }

    $(document).ready(function() {
        var DataFrame = dfjs.DataFrame;

        $('.calendar-comp').calendar({
            type: 'date',
            firstDayOfWeek: 1,
            minDate: new Date(2020, 5, 1),
            maxDate: new Date(2022, 4, 31),
            text: {
                days: ['D', 'L', 'M', 'X', 'J', 'V', 'S'],
                months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                monthsShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                today: 'Hoy',
                now: 'Ahora',
                am: 'AM',
                pm: 'PM'
            },
            formatter: {
                date: function (date, settings) {
                    if (!date) return '';
                    var day = date.getDate();
                    var month = date.getMonth() + 1;
                    var year = date.getFullYear();

                    return day.toString().padStart(2, '0') + '/' + month.toString().padStart(2, '0') + '/' + year;
                }
            }
        });

        let monthConsumptionCache = {};

        $('.day-add').click(handler => {
            $dateElement = $('input[name="date"]');
            let selectedDate = $dateElement.val();

            if (!selectedDate) {
                $dateElement.parents('.calendar-comp').effect('shake', { times: 4, distance: 8 }, 750);
            } else {
                let rawDay = selectedDate.substr(0, 2);
                let day = parseInt(rawDay);
                let rawMonth = selectedDate.substr(3, 2);
                let rawYear = selectedDate.substr(6, 4);

                if (!db.containsDate(selectedDate)) {
                    let monthConsumptionKey = `${rawYear}${rawMonth}`;

                    if (!(monthConsumptionKey in monthConsumptionCache)) {
                        $.get(`/energydatum/data/consumption/raw/moy/consumption_raw_${rawYear}${rawMonth}.json`).done(response => {
                            let dfMonthConsumption = new DataFrame(response.data, response.columns);

                            monthConsumptionCache[monthConsumptionKey] = dfMonthConsumption;

                            values = getValuesFromMonthConsumptionDf(dfMonthConsumption, day);

                            data = db.addDate(selectedDate, values);
                            addSelectedDay(data);

                            Plotly.newPlot('consumption-figure', db.getData(), plotlyFigureLayout, plotlyFigureConfig);
                        });
                    } else {
                        values = getValuesFromMonthConsumptionDf(monthConsumptionCache[monthConsumptionKey], day);

                        data = db.addDate(selectedDate, values);
                        addSelectedDay(data);

                        Plotly.newPlot('consumption-figure', db.getData(), plotlyFigureLayout, plotlyFigureConfig);
                    }
                }

                $dateElement.val('');
            }
        });

        if (db.hasData()) {
            Plotly.newPlot('consumption-figure', db.getData(), plotlyFigureLayout, plotlyFigureConfig);
            db.getData().forEach(data => addSelectedDay(data));
        }

        $(document).on('click', '.day-remove', handler => {
            let $dayElement = $(handler.currentTarget).parents('.selected-day');
            let date = $dayElement.data('date');

            $dayElement.remove();

            db.removeDate(date);

            if (db.hasData()) {
                Plotly.newPlot('consumption-figure', db.getData(), plotlyFigureLayout, plotlyFigureConfig);
            } else {
                $('#consumption-figure').empty();
                $('#selected-days').append($('<p class="nocontent">').text('No se ha seleccionado ningún día'));
            }
        });
    });
</script>

</body>
</html>